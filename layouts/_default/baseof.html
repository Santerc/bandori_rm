<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ block "title" . }}{{ .Title }} | {{ .Site.Title }}{{ end }}</title>
    
    <script>
        (function() {
            // 1. è¯»å–æœ¬åœ°å­˜å‚¨
            const savedTheme = localStorage.getItem('theme');
            // 2. è¯»å–ç³»ç»Ÿåå¥½ (æ˜¯å¦æ˜¯æ·±è‰²æ¨¡å¼)
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // 3. ç«‹å³è®¾ç½®å±æ€§
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                // å¦‚æœæ˜¯æµ…è‰²ï¼Œç§»é™¤å±æ€§ (æˆ–è€…æ˜¯ setAttribute('data-theme', 'light'))
                document.documentElement.removeAttribute('data-theme');
            }
        })();
    </script>

    <!-- æ ·å¼è¡¨ -->
    {{ $style := resources.Get "css/main.css" }}
    {{ if $style }}
        {{ $style = $style | minify | fingerprint }}
        <link rel="stylesheet" href="{{ $style.RelPermalink }}" integrity="{{ $style.Data.Integrity }}" id="main-css">
        <script>console.log("CSS Mode: Assets Pipeline (Minified & Fingerprinted)", "{{ $style.RelPermalink }}");</script>
    {{ else }}
        <!-- å¦‚æœ assets ä¸­æ‰¾ä¸åˆ°ï¼Œå°è¯•åŠ è½½ static ç›®å½•ä¸‹çš„æ–‡ä»¶ -->
        <link rel="stylesheet" href="{{ "css/main.css" | relURL }}" id="main-css">
        <script>console.log("CSS Mode: Static Fallback (RelURL)", "{{ "css/main.css" | relURL }}");</script>
    {{ end }}

    <style>
        html {
            font-size: 80%; /* è¿™ä¼šè®©é¡µé¢æ‰€æœ‰åŸºäº rem çš„å°ºå¯¸ç¼©å°åˆ° 80% */
        }
    </style>

    <!-- Global Playlist Data -->
    <script>
        window.sitePlaylist = [];
        {{ $about := .Site.GetPage "about" }}
        {{ if $about.Params.playlist }}
            {{ range $about.Params.playlist }}
            window.sitePlaylist.push({
                title: "{{ .title }}",
                artist: "{{ .artist }}",
                cover: "{{ .cover }}",
                theme: "{{ .theme }}",
                url: "{{ if .url }}{{ .url | relURL }}{{ else }}https://music.163.com/song/media/outer/url?id={{ .id }}.mp3{{ end }}"
            });
            {{ end }}
        {{ else }}
            // Fallback if no playlist defined
            window.sitePlaylist.push({
                title: "Unknown",
                artist: "Unknown",
                cover: "",
                url: ""
            });
        {{ end }}
    </script>
    
    <!-- Global Music Player Logic -->
    <script src="{{ "js/music-player.js" | relURL }}"></script>

    <!-- è°ƒè¯•è„šæœ¬ï¼šæ£€æŸ¥ CSS æ˜¯å¦çœŸçš„åŠ è½½æˆåŠŸ -->
    {{/*  <script>
        window.addEventListener('load', function() {
            const cssLink = document.getElementById('main-css');
            if (cssLink) {
                // å°è¯•è·å–æ ·å¼è¡¨å¯¹è±¡
                try {
                    const sheet = cssLink.sheet;
                    if (sheet && sheet.cssRules.length > 0) {
                        console.log("âœ… CSS Loaded Successfully! Rules count:", sheet.cssRules.length);
                    } else {
                        console.warn("âš ï¸ CSS File found but seems empty or blocked by CORS.");
                    }
                } catch (e) {
                    console.warn("âš ï¸ CSS Loaded but cannot access rules (likely CORS issue if on CDN/different domain):", e);
                }
                
                // å†æ¬¡ç¡®è®¤è®¡ç®—æ ·å¼
                const bodyColor = window.getComputedStyle(document.body).color;
                console.log("ğŸ¨ Computed Body Color:", bodyColor);
            } else {
                console.error("âŒ CSS Link Element NOT FOUND!");
            }
        });
    </script>  */}}
    <script>
        // 1. è·å– Hugo æ¸²æŸ“æ—¶çš„ BaseURL (ä¾‹å¦‚: "https://santerc.github.io/blog/")
        const siteBaseURL = "{{ .Site.BaseURL }}";

        // 2. å®šä¹‰å…¨å±€å·¥å…·å‡½æ•°ï¼Œæ¨¡æ‹Ÿ Hugo çš„ absURL
        window.absURL = function(path) {
            // å¦‚æœè·¯å¾„å·²ç»æ˜¯ http å¼€å¤´ï¼Œç›´æ¥è¿”å›
            if (path && (path.indexOf('http://') === 0 || path.indexOf('https://') === 0)) {
                return path;
            }
            
            // ç¡®ä¿ path ä¸ä»¥ / å¼€å¤´ (å› ä¸º BaseURL é€šå¸¸å·²æœ‰å°¾éƒ¨ /)
            if (path && path.indexOf('/') === 0) {
                path = path.substring(1);
            }

            return siteBaseURL + (path || "");
        };
        
        // å…¼å®¹æ—§ä»£ç çš„ baseURL å˜é‡
        window.baseURL = siteBaseURL;
    </script>

    <!-- Fuse.js æœç´¢åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

     {{ if .Params.math }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
        onload="renderMathInElement(document.body, {
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false}
          ]
        });"></script>
    {{ end }}

</head>
<body>
    <!-- ğŸ“± ç§»åŠ¨ç«¯é®ç½©å±‚ (ç‚¹å‡»å…³é—­ä¾§è¾¹æ ) -->
    <div id="mobile-backdrop"></div>
    <!-- 1. é¡¶éƒ¨é€šæ  -->
    {{ partial "header.html" . }}

    <!-- 2. æ ¸å¿ƒä¸‰æ ç½‘æ ¼ -->
    <div class="grid-container">
        <aside class="sidebar-left">
            {{ partial "sidebar-left.html" . }}
        </aside>

        <main class="main-content">
            {{ block "main" . }}{{ end }}
        </main>

        <aside class="sidebar-right">
            {{ partial "sidebar-right.html" . }}
        </aside>
    </div>

    <!-- 3. åº•éƒ¨ -->
    {{ partial "footer.html" . }}

    <!-- è„šæœ¬èµ„æº -->

    <!-- æ•°å­¦å…¬å¼æ”¯æŒ (KaTeX) -->
    {{ if .Params.math }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
        onload="renderMathInElement(document.body, {
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false}
          ]
        });"></script>
    {{ end }}

    {{ $js := resources.Get "js/main.js" | minify }}
    <script src="{{ $js.Permalink }}"></script>

    {{ $cursor := resources.Get "js/cursor.js" | minify }}
    <script src="{{ $cursor.Permalink }}"></script>
    
    {{ $search := resources.Get "js/search.js" | minify }}
    <script src="{{ $search.Permalink }}"></script>
</body>
</html>
